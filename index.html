<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MandalarT — 목표를 디자인하세요</title>

  <!-- Favicon - generated dynamically with Caveat font -->
  <link rel="icon" id="favicon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script defer src="https://umami.ericpark.me/script.js" data-website-id="84d37d5b-4ead-4f16-821a-c4eb07e64dad"></script>

  <style>
    :root {
      --paper-cream: #f8f4e8;
      --paper-light: #fefdfb;
      --paper-aged: #f0e9d8;
      --ink-primary: #2d2d2d;
      --ink-secondary: #4a4a4a;
      --ink-muted: #6b6b6b;
      --accent-coral: #e8a598;
      --accent-coral-light: #f0c5bb;
      --accent-sage: #a8c5a8;
      --accent-sage-light: #c5d8c5;
      --accent-sand: #d4c5a9;
      --accent-sand-light: #e5d9c3;
      --border-color: #c9bfab;
      --ui-shadow: rgba(45, 45, 45, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, var(--paper-cream) 0%, var(--paper-aged) 100%);
      color: var(--ink-primary);
      display: flex;
      flex-direction: column;
    }

    /* Paper grain texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='paper'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3'/%3E%3CfeColorMatrix values='0 0 0 0 0.95 0 0 0 0 0.92 0 0 0 0 0.88 0 0 0 1 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paper)' opacity='0.15'/%3E%3C/svg%3E");
      background-size: 200px 200px;
      pointer-events: none;
      z-index: 1000;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 0.5rem 1rem 0.25rem;
      flex-shrink: 0;
    }

    .logo {
      font-family: 'Caveat', cursive;
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      font-weight: 600;
      color: var(--ink-primary);
      margin: 0;
      letter-spacing: 0.02em;
      position: relative;
      display: inline-block;
    }

    .logo::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 2px;
      background: repeating-linear-gradient(
        90deg,
        var(--ink-muted) 0px,
        var(--ink-muted) 4px,
        transparent 4px,
        transparent 8px
      );
    }

    .tagline {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 0.8rem;
      color: var(--ink-muted);
      margin-top: 0.25rem;
      font-weight: 300;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem;
      flex-shrink: 0;
    }

    .btn {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 0.4rem 0.9rem;
      border: 2px solid var(--ink-primary);
      background: var(--paper-cream);
      cursor: pointer;
      border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px var(--ui-shadow);
    }

    .btn-primary {
      background: var(--ink-primary);
      color: var(--paper-cream);
    }

    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      padding: 0.25rem;
      flex-shrink: 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.75rem;
      color: var(--ink-secondary);
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid var(--ink-secondary);
    }

    .legend-color.center { background: var(--accent-coral); }
    .legend-color.sub { background: var(--accent-sage); }
    .legend-color.action { background: var(--accent-sand); }

    /* Main Container */
    .main-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.25rem;
      min-height: 0;
    }

    /* Grid Wrapper */
    .mandalart-wrapper {
      position: relative;
      background: var(--paper-cream);
      padding: 0.75rem;
      border-radius: 4px 6px 4px 6px;
      box-shadow:
        0 8px 32px var(--ui-shadow),
        0 1px 0 var(--paper-light) inset;
      width: min(92vmin, 720px);
      height: min(92vmin, 720px);
    }

    .mandalart-wrapper::before {
      content: '';
      position: absolute;
      top: 6px;
      left: 6px;
      right: 6px;
      bottom: 6px;
      border: 1px dashed var(--border-color);
      border-radius: 3px;
      pointer-events: none;
    }

    /* 9x9 Mandalart Grid - Sketchbook Style */
    .mandalart-grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(9, 1fr);
      gap: 0;
      width: 100%;
      height: 100%;
      background: var(--paper-light);
    }

    /* Cell Base - Sketched borders */
    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      cursor: pointer;
      padding: 2px;
      transition: all 0.2s ease;
      background: var(--paper-light);
      border: 1px solid #c5b8a8;
    }

    .cell-text {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: clamp(0.48rem, 1.1vmin, 0.72rem);
      color: var(--ink-primary);
      line-height: 1.25;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      word-break: keep-all;
    }

    .cell-placeholder {
      color: #a89e8e;
      opacity: 0.6;
      font-size: clamp(0.42rem, 0.9vmin, 0.6rem);
    }

    /* Center Cell - Main Goal */
    .cell.center-main {
      background:
        radial-gradient(circle, #fff8f5 0%, #fff0eb 50%, #ffe8e0 100%);
      border: 2px solid #d4a090;
      border-radius: 50%;
      z-index: 10;
    }

    .cell.center-main .cell-text {
      font-size: clamp(0.52rem, 1.25vmin, 0.78rem);
      font-weight: 700;
      color: #6a4a4a;
      -webkit-line-clamp: 2;
      letter-spacing: -0.01em;
    }

    .cell.center-main .cell-placeholder {
      color: #a08078;
      opacity: 0.8;
      font-weight: 500;
    }

    .cell.center-main:hover {
      background:
        radial-gradient(circle, #fff0eb 0%, #ffe0d5 50%, #ffd5c8 100%);
      border-color: #c08070;
    }

    .cell.center-main:hover .cell-text {
      color: #5a3535;
    }

    /* Center Section Sub-goals */
    .cell.center-sub {
      background: var(--accent-sage-light);
      border: 1px solid var(--accent-sage);
    }

    .cell.center-sub .cell-text {
      font-size: clamp(0.5rem, 1.2vmin, 0.75rem);
      font-weight: 500;
      color: #3a4a3a;
    }

    .cell.center-sub .cell-placeholder {
      color: #6a7a6a;
      opacity: 0.6;
    }

    /* Outer Section Centers */
    .cell.outer-center {
      background: #d8e8d8;
      border: 1px dashed #a8c8a8;
    }

    .cell.outer-center .cell-text {
      font-size: clamp(0.5rem, 1.2vmin, 0.75rem);
      font-weight: 500;
      color: #3a4a3a;
    }

    .cell.outer-center .cell-placeholder {
      color: #7a8a7a;
      opacity: 0.6;
    }

    /* Outer Section Actions */
    .cell.outer-action {
      background: var(--paper-light);
      border: 1px solid #d0c4b4;
    }

    .cell.outer-action .cell-text {
      color: var(--ink-secondary);
    }

    .cell.outer-action .cell-placeholder {
      color: #b0a498;
    }

    /* Section dividers - thicker sketch lines */
    .cell[data-col="2"] {
      border-right: 2px solid #a09080;
    }
    .cell[data-col="5"] {
      border-right: 2px solid #a09080;
    }
    .cell[data-row="2"] {
      border-bottom: 2px solid #a09080;
    }
    .cell[data-row="5"] {
      border-bottom: 2px solid #a09080;
    }

    /* Hover effects */
    .cell:hover {
      background: #f5f0e5;
      z-index: 5;
    }

    .cell.center-sub:hover {
      background: var(--accent-sage);
    }

    .cell.outer-center:hover {
      background: #c8dcc8;
    }

    .cell.outer-action:hover {
      background: var(--accent-sand-light);
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 0.35rem;
      flex-shrink: 0;
    }

    .footer-divider {
      width: 120px;
      height: 2px;
      background: repeating-linear-gradient(
        90deg,
        var(--border-color) 0px,
        var(--border-color) 4px,
        transparent 4px,
        transparent 8px
      );
      margin: 0 auto 0.3rem;
    }

    .footer p {
      font-size: 0.7rem;
      color: var(--ink-muted);
    }

    /* ==================== MODAL ==================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(45, 45, 45, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--paper-cream);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      width: min(90vw, 400px);
      max-height: 80vh;
      overflow: hidden;
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px dashed var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-type {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-type-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid var(--ink-secondary);
    }

    .modal-type-dot.center { background: var(--accent-coral); }
    .modal-type-dot.sub { background: var(--accent-sage); }
    .modal-type-dot.action { background: var(--accent-sand); }

    .modal-type-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--ink-secondary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--ink-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--ink-primary);
    }

    .modal-body {
      padding: 1.25rem;
    }

    .modal-context {
      font-size: 0.8rem;
      color: var(--ink-muted);
      margin-bottom: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: var(--paper-aged);
      border-radius: 6px;
    }

    .modal-context strong {
      color: var(--ink-secondary);
    }

    .modal-textarea {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--paper-light);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 1rem;
      color: var(--ink-primary);
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
    }

    .modal-textarea:focus {
      border-color: var(--accent-sage);
    }

    .modal-textarea::placeholder {
      color: var(--ink-muted);
      opacity: 0.5;
    }

    .modal-footer {
      padding: 1rem 1.25rem;
      border-top: 1px dashed var(--border-color);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .modal-btn {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      padding: 0.6rem 1.25rem;
      border: 2px solid var(--ink-primary);
      background: var(--paper-cream);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .modal-btn:hover {
      background: var(--paper-aged);
    }

    .modal-btn-save {
      background: var(--ink-primary);
      color: var(--paper-cream);
    }

    .modal-btn-save:hover {
      background: var(--ink-secondary);
    }

    /* Tips Modal */
    .tips-modal {
      width: min(90vw, 480px);
      max-height: 85vh;
    }

    .tips-body {
      max-height: 60vh;
      overflow-y: auto;
    }

    .tip-section {
      margin-bottom: 1.25rem;
    }

    .tip-section:last-child {
      margin-bottom: 0;
    }

    .tip-section h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--ink-primary);
      margin-bottom: 0.5rem;
      padding-bottom: 0.35rem;
      border-bottom: 1px dashed var(--border-color);
    }

    .tip-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tip-section li {
      font-size: 0.82rem;
      color: var(--ink-secondary);
      line-height: 1.5;
      padding: 0.3rem 0;
      padding-left: 1rem;
      position: relative;
    }

    .tip-section li::before {
      content: '·';
      position: absolute;
      left: 0;
      color: var(--ink-muted);
    }

    .tip-section li strong {
      color: var(--ink-primary);
      font-weight: 500;
    }

    /* Print Styles */
    @media print {
      body::before { display: none; }
      .toolbar, .legend, .footer, .modal-overlay { display: none; }
      body { background: white; }
      .main-container { padding: 0; }
      .mandalart-wrapper {
        box-shadow: none;
        border: 2px solid #333;
        width: 100%;
        height: auto;
        aspect-ratio: 1;
      }
      .mandalart-wrapper::before { display: none; }
    }

    /* Mobile */
    @media (max-width: 500px) {
      .header { padding: 0.5rem; }
      .logo { font-size: 1.5rem; }
      .tagline { font-size: 0.7rem; }
      .toolbar { gap: 0.3rem; padding: 0.3rem; }
      .btn { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
      .legend { gap: 0.8rem; padding: 0.3rem; }
      .legend-item { font-size: 0.65rem; gap: 0.25rem; }
      .legend-color { width: 10px; height: 10px; }
      .mandalart-wrapper { padding: 0.5rem; }
      .footer { padding: 0.3rem; }
      .modal { width: 95vw; }
      .modal-textarea { min-height: 100px; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <h1 class="logo">MandalarT</h1>
    <p class="tagline">목표를 디자인하고, 실천하세요</p>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn btn-subtle" onclick="openTipsModal()">만다라트 팁</button>
    <button class="btn" onclick="loadExample()">예시 보기</button>
    <button class="btn btn-primary" onclick="saveAsImage()">이미지 저장</button>
    <button class="btn" onclick="exportJSON()">데이터 내보내기</button>
    <button class="btn btn-danger" onclick="clearAll()">초기화</button>
  </div>

  <!-- Hidden export container -->
  <div id="exportContainer" style="position: absolute; left: -9999px; top: 0;"></div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-item">
      <div class="legend-color center"></div>
      <span>핵심 목표</span>
    </div>
    <div class="legend-item">
      <div class="legend-color sub"></div>
      <span>세부 목표</span>
    </div>
    <div class="legend-item">
      <div class="legend-color action"></div>
      <span>실천 항목</span>
    </div>
  </div>

  <!-- Main Grid -->
  <main class="main-container">
    <div class="mandalart-wrapper">
      <div class="mandalart-grid" id="mandalartGrid"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-divider"></div>
    <p>마음을 디자인하고, 삶을 변화시키세요</p>
  </footer>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-type">
          <div class="modal-type-dot" id="modalTypeDot"></div>
          <span class="modal-type-label" id="modalTypeLabel"></span>
        </div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-context" id="modalContext"></div>
        <textarea
          class="modal-textarea"
          id="modalTextarea"
          placeholder="내용을 입력하세요..."
        ></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" onclick="closeModal()">취소</button>
        <button class="modal-btn modal-btn-save" onclick="saveModal()">저장</button>
      </div>
    </div>
  </div>

  <!-- Tips Modal -->
  <div class="modal-overlay" id="tipsModalOverlay">
    <div class="modal tips-modal">
      <div class="modal-header">
        <div class="modal-type">
          <span class="modal-type-label">효과적인 만다라트를 위한 팁</span>
        </div>
        <button class="modal-close" onclick="closeTipsModal()">&times;</button>
      </div>
      <div class="modal-body tips-body">
        <div class="tip-section">
          <h3>핵심 목표 설정</h3>
          <ul>
            <li><strong>구체적으로</strong> — "성공하기"보다 "2024년 승진하기"처럼 명확하게</li>
            <li><strong>측정 가능하게</strong> — 달성 여부를 판단할 수 있도록</li>
            <li><strong>현실적으로</strong> — 1년 안에 이룰 수 있는 목표로</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>8가지 세부 목표</h3>
          <ul>
            <li><strong>균형있게</strong> — 건강, 관계, 재정, 성장 등 삶의 다양한 영역 포함</li>
            <li><strong>연결되게</strong> — 각 세부 목표가 핵심 목표 달성에 기여하도록</li>
            <li><strong>독립적으로</strong> — 서로 겹치지 않는 별개의 영역으로</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>실천 항목 작성</h3>
          <ul>
            <li><strong>행동 중심</strong> — "운동하기"보다 "매일 아침 30분 걷기"</li>
            <li><strong>작게 시작</strong> — 당장 실천할 수 있는 작은 행동으로</li>
            <li><strong>습관화</strong> — 반복할 수 있는 일상적인 행동으로</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>활용 팁</h3>
          <ul>
            <li>매주 검토하며 진행 상황 체크하기</li>
            <li>완료한 항목은 표시하며 성취감 느끼기</li>
            <li>필요시 실천 항목 수정하기 (목표는 유지)</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-save" onclick="closeTipsModal()">확인</button>
      </div>
    </div>
  </div>

  <script>
    let gridData = {
      mainGoal: '',
      subGoals: Array(8).fill(''),
      actions: Array(8).fill(null).map(() => Array(8).fill(''))
    };

    let currentEdit = null;

    const getSectionIndex = (row, col) => {
      const sectionRow = Math.floor(row / 3);
      const sectionCol = Math.floor(col / 3);
      return sectionRow * 3 + sectionCol;
    };

    const getPositionInSection = (row, col) => {
      const localRow = row % 3;
      const localCol = col % 3;
      return localRow * 3 + localCol;
    };

    const centerPosToSubGoalIndex = {
      0: 0, 1: 1, 2: 2,
      3: 3,       5: 4,
      6: 5, 7: 6, 8: 7
    };

    const sectionToSubGoalIndex = {
      0: 0, 1: 1, 2: 2,
      3: 3,       5: 4,
      6: 5, 7: 6, 8: 7
    };

    const outerPosToActionIndex = {
      0: 0, 1: 1, 2: 2,
      3: 3,       5: 4,
      6: 5, 7: 6, 8: 7
    };

    const subGoalLabels = [
      '좌상단', '상단', '우상단',
      '좌측', '우측',
      '좌하단', '하단', '우하단'
    ];

    function generateGrid() {
      const grid = document.getElementById('mandalartGrid');
      grid.innerHTML = '';

      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = row;
          cell.dataset.col = col;

          const sectionIndex = getSectionIndex(row, col);
          const posInSection = getPositionInSection(row, col);

          const textSpan = document.createElement('span');
          textSpan.className = 'cell-text';

          let cellType, value, placeholder, subGoalIdx, actionIdx;

          if (sectionIndex === 4) {
            if (posInSection === 4) {
              cellType = 'center-main';
              value = gridData.mainGoal;
              placeholder = '핵심 목표';
              cell.onclick = () => openModal('main', null, null);
            } else {
              cellType = 'center-sub';
              subGoalIdx = centerPosToSubGoalIndex[posInSection];
              value = gridData.subGoals[subGoalIdx];
              placeholder = '세부 목표';
              cell.onclick = () => openModal('sub', subGoalIdx, null);
            }
          } else {
            subGoalIdx = sectionToSubGoalIndex[sectionIndex];

            if (posInSection === 4) {
              cellType = 'outer-center';
              value = gridData.subGoals[subGoalIdx];
              placeholder = '세부 목표';
              cell.dataset.linkedSubGoal = subGoalIdx;
              cell.onclick = () => openModal('sub', subGoalIdx, null);
            } else {
              cellType = 'outer-action';
              actionIdx = outerPosToActionIndex[posInSection];
              value = gridData.actions[subGoalIdx][actionIdx];
              placeholder = '';
              cell.onclick = () => openModal('action', subGoalIdx, actionIdx);
            }
          }

          cell.classList.add(cellType);

          if (value) {
            textSpan.textContent = value;
          } else {
            textSpan.textContent = placeholder;
            textSpan.classList.add('cell-placeholder');
          }

          cell.appendChild(textSpan);
          grid.appendChild(cell);
        }
      }
    }

    function openModal(type, subGoalIdx, actionIdx) {
      currentEdit = { type, subGoalIdx, actionIdx };

      const overlay = document.getElementById('modalOverlay');
      const typeDot = document.getElementById('modalTypeDot');
      const typeLabel = document.getElementById('modalTypeLabel');
      const context = document.getElementById('modalContext');
      const textarea = document.getElementById('modalTextarea');

      typeDot.className = 'modal-type-dot';
      if (type === 'main') {
        typeDot.classList.add('center');
        typeLabel.textContent = '핵심 목표';
        context.style.display = 'none';
        textarea.value = gridData.mainGoal;
        textarea.placeholder = '당신의 핵심 목표는 무엇인가요?';
      } else if (type === 'sub') {
        typeDot.classList.add('sub');
        typeLabel.textContent = '세부 목표';
        context.style.display = 'block';
        context.innerHTML = `<strong>위치:</strong> ${subGoalLabels[subGoalIdx]} 영역`;
        textarea.value = gridData.subGoals[subGoalIdx];
        textarea.placeholder = '이 영역에서 달성하고 싶은 목표는?';
      } else if (type === 'action') {
        typeDot.classList.add('action');
        typeLabel.textContent = '실천 항목';
        context.style.display = 'block';
        const subGoalName = gridData.subGoals[subGoalIdx] || '(미정)';
        context.innerHTML = `<strong>상위 목표:</strong> ${subGoalName}`;
        textarea.value = gridData.actions[subGoalIdx][actionIdx];
        textarea.placeholder = '구체적인 실천 방법을 적어보세요';
      }

      overlay.classList.add('active');
      setTimeout(() => textarea.focus(), 100);
    }

    function closeModal() {
      const overlay = document.getElementById('modalOverlay');
      overlay.classList.remove('active');
      currentEdit = null;
    }

    function openTipsModal() {
      document.getElementById('tipsModalOverlay').classList.add('active');
    }

    function closeTipsModal() {
      document.getElementById('tipsModalOverlay').classList.remove('active');
    }

    function saveModal() {
      const textarea = document.getElementById('modalTextarea');
      const value = textarea.value.trim();

      if (currentEdit.type === 'main') {
        gridData.mainGoal = value;
      } else if (currentEdit.type === 'sub') {
        gridData.subGoals[currentEdit.subGoalIdx] = value;
      } else if (currentEdit.type === 'action') {
        gridData.actions[currentEdit.subGoalIdx][currentEdit.actionIdx] = value;
      }

      saveToStorage();
      generateGrid();
      closeModal();
    }

    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'modalOverlay') {
        closeModal();
      }
    });

    document.getElementById('tipsModalOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'tipsModalOverlay') {
        closeTipsModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('tipsModalOverlay').classList.contains('active')) {
          closeTipsModal();
        } else if (document.getElementById('modalOverlay').classList.contains('active')) {
          closeModal();
        }
      }
      if (document.getElementById('modalOverlay').classList.contains('active')) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          saveModal();
        }
      }
    });

    function saveToStorage() {
      localStorage.setItem('mandalartData', JSON.stringify(gridData));
    }

    function loadFromStorage() {
      const saved = localStorage.getItem('mandalartData');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          gridData = {
            mainGoal: parsed.mainGoal || '',
            subGoals: parsed.subGoals || Array(8).fill(''),
            actions: parsed.actions || Array(8).fill(null).map(() => Array(8).fill(''))
          };
        } catch (e) {
          console.log('Could not load saved data');
        }
      }
    }

    async function saveAsImage() {
      const exportContainer = document.getElementById('exportContainer');
      exportContainer.innerHTML = '';

      const exportWrapper = document.createElement('div');
      exportWrapper.style.cssText = `
        width: 800px;
        padding: 40px;
        background: linear-gradient(135deg, #f8f4e8 0%, #f0e9d8 100%);
        font-family: 'Noto Sans KR', sans-serif;
      `;

      const logoDiv = document.createElement('div');
      logoDiv.style.cssText = `
        text-align: center;
        margin-bottom: 24px;
      `;
      logoDiv.innerHTML = `
        <h1 style="font-family: 'Caveat', cursive; font-size: 48px; font-weight: 600; color: #2d2d2d; margin: 0;">MandalarT</h1>
        <p style="font-size: 14px; color: #6b6b6b; margin-top: 4px;">목표를 디자인하고, 실천하세요</p>
      `;
      exportWrapper.appendChild(logoDiv);

      const gridClone = document.querySelector('.mandalart-wrapper').cloneNode(true);
      gridClone.style.cssText = `
        width: 720px;
        height: 720px;
        margin: 0 auto;
        background: #f8f4e8;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        position: relative;
      `;

      // Add dashed border element (since ::before doesn't export)
      const dashedBorder = document.createElement('div');
      dashedBorder.style.cssText = `
        position: absolute;
        top: 6px;
        left: 6px;
        right: 6px;
        bottom: 6px;
        border: 1px dashed #c9bfab;
        border-radius: 3px;
        pointer-events: none;
      `;
      gridClone.appendChild(dashedBorder);

      exportWrapper.appendChild(gridClone);
      exportContainer.appendChild(exportWrapper);

      await document.fonts.ready;

      try {
        const canvas = await html2canvas(exportWrapper, {
          scale: 2,
          backgroundColor: null,
          useCORS: true,
          logging: false
        });

        const link = document.createElement('a');
        link.download = 'mandalart-chart.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        console.error('Export failed:', err);
        alert('이미지 저장에 실패했습니다. 다시 시도해주세요.');
      }

      exportContainer.innerHTML = '';
    }

    function exportJSON() {
      const dataStr = JSON.stringify(gridData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mandalart-data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearAll() {
      if (!hasExistingData()) return;

      if (confirm('모든 내용이 삭제됩니다. 계속하시겠습니까?')) {
        gridData = {
          mainGoal: '',
          subGoals: Array(8).fill(''),
          actions: Array(8).fill(null).map(() => Array(8).fill(''))
        };
        localStorage.removeItem('mandalartData');
        generateGrid();
      }
    }

    function hasExistingData() {
      if (gridData.mainGoal) return true;
      if (gridData.subGoals.some(g => g)) return true;
      if (gridData.actions.some(row => row.some(a => a))) return true;
      return false;
    }

    function loadExample() {
      if (hasExistingData()) {
        if (!confirm('현재 작성된 내용이 모두 삭제되고 예시 데이터로 대체됩니다. 계속하시겠습니까?')) {
          return;
        }
      }

      gridData = {
        mainGoal: '2024년 최고의 나 되기',
        subGoals: [
          '건강한 몸 만들기', '지식과 역량 성장', '커리어 도약',
          '소중한 관계 유지', '재정적 안정',
          '취미와 여가 즐기기', '마음의 평화', '가족과 함께'
        ],
        actions: [
          ['매일 아침 30분 운동', '물 2L 마시기', '7시간 수면 확보', '건강한 식단 유지', '정기 건강검진', '스트레칭 루틴', '계단 이용하기', '금연 유지'],
          ['월 2권 독서하기', '영어 공부 30분', '온라인 강좌 수강', '글쓰기 습관', '강연 참석', '자격증 취득', '스터디 참여', '뉴스레터 구독'],
          ['업무 효율화', '새로운 스킬 습득', '네트워킹 확대', '포트폴리오 갱신', '발표 능력 향상', '협업 스킬 개선', '피드백 수용', '분기별 목표 설정'],
          ['친구에게 먼저 연락', '약속 꼭 지키기', '경청하는 습관', '감사 표현하기', '새로운 만남 가지기', '소모임 참여', '축하해주기', '선물하기'],
          ['가계부 작성', '월급 10% 저축', '투자 공부', '보험 정리', '불필요한 소비 줄이기', '부채 상환', '비상금 마련', '재테크 책 읽기'],
          ['여행 계획 세우기', '사진 촬영 취미', '새로운 요리 도전', '스포츠 경기 관람', '전시회 방문', '콘서트 가기', '캠핑 떠나기', '드라이브 즐기기'],
          ['매일 10분 명상', '감정 일기 쓰기', '감사 일기', '긍정적 생각 훈련', '스트레스 관리법 배우기', '상담 받기', '충분한 휴식', '자연 속 산책'],
          ['부모님께 주 1회 연락', '가족 여행 가기', '집안일 분담', '대화 시간 갖기', '기념일 챙기기', '가족 사진 찍기', '가족에게 요리해주기', '함께 운동하기']
        ]
      };
      saveToStorage();
      generateGrid();
    }

    loadFromStorage();
    generateGrid();

    // Generate favicon with Caveat font
    document.fonts.ready.then(() => {
      const canvas = document.createElement('canvas');
      canvas.width = 64;
      canvas.height = 64;
      const ctx = canvas.getContext('2d');

      // Background
      ctx.fillStyle = '#f8f4e8';
      ctx.beginPath();
      ctx.roundRect(0, 0, 64, 64, 10);
      ctx.fill();

      // Letter M in Caveat
      ctx.fillStyle = '#2d2d2d';
      ctx.font = '600 52px Caveat';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('M', 32, 36);

      // Set as favicon
      const link = document.getElementById('favicon');
      link.type = 'image/png';
      link.href = canvas.toDataURL('image/png');
    });
  </script>
</body>
</html>
